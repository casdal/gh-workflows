name: Cache Container Image

on:
  workflow_call:
    inputs:
      image_name:
        description: "The full image name (with tag) to cache."
        required: true
        type: string

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    steps:
      - name: Restore Image Cache
        id: cache-img-${{ inputs.image_name }}
        uses: actions/cache@v3
        with:
          path: ci/cache/docker/${{ inputs.image_name }}
          key: cache-docker-${{ inputs.image_name }}

      - name: Update Image Cache
        if: steps.cache-img-${{ inputs.image_name }}.outputs.cache-hit != 'true'
        run: |
          docker pull ${{ inputs.image_name }}
          mkdir -p ci/cache/docker/${{ inputs.registry }}
          docker image save ${{ inputs.image_name }} \
            --output ./ci/cache/docker/${{ inputs.image_name }}/${{ inputs.image_name }}.tar

      - name: Use Image Cache
        if: steps.cache-img-${{ inputs.image_name }}.outputs.cache-hit == 'true'
        run: docker image load --input ./ci/cache/docker/${{ inputs.image_name }}/${{ inputs.image_name }}.tar
